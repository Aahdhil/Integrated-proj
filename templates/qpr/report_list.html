{% extends "master.html" %}
{% load static %}
{% load translate_tags %}

{% block title %}{{ "Report List"|t:current_lang }}{% endblock %}

{% block extra_css %}
<style>
    /* Add specific styles if needed */
</style>
{% endblock %}

{% block content %}
<div class="container my-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>{{ "Report List"|t:current_lang }}</h4>
        <div>
            <a href="{% url 'qpr_form' %}" class="btn btn-outline-secondary me-2">
                {{ "Fill New Report"|t:current_lang }}
            </a>
            <a href="{% url 'qpr_user_dashboard' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> {{ "Back to Dashboard"|t:current_lang }}
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>{{ "Office Name"|t:current_lang }}</th>
                            <th>{{ "Code"|t:current_lang }}</th>
                            <th>{{ "Region"|t:current_lang }}</th>
                            <th>{{ "Quarter"|t:current_lang }}</th>
                            <th>{{ "Status"|t:current_lang }}</th>
                            <th>{{ "Action"|t:current_lang }}</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    const API_URL = "{% url 'qpr_api_records' %}";

    // Function to mask sensitive fields
    function maskSensitiveData(value) {
        if (!value || value === '-') return '-';
        const valueStr = String(value);
        if (valueStr.length <= 2) return valueStr;
        return valueStr.charAt(0) + '*'.repeat(valueStr.length - 2) + valueStr.charAt(valueStr.length - 1);
    }

    async function loadList() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">{{ "No records found"|t:current_lang }}</td></tr>';
                return;
            }

            data.forEach(r => {
                const tr = document.createElement('tr');

                const status = r.status === 'Draft'
                    ? '<span class="badge bg-primary">{{ "Draft"|t:current_lang }}</span>'
                    : '<span class="badge bg-success">{{ "Submitted"|t:current_lang }}</span>';

                let actionButtons = '';

                if (r.status === 'Draft') {
                    actionButtons = `<button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); edit(${r.id})">{{ "Edit"|t:current_lang }}</button>`;
                } else if (r.edit_approved) {
                    actionButtons = `<button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); edit(${r.id})">{{ "Edit"|t:current_lang }}</button>`;
                } else {
                    actionButtons = `<button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); requestEdit(${r.id})">{{ "Request to Edit"|t:current_lang }}</button>`;
                }

                const maskedCode = maskSensitiveData(r.officeCode);

                tr.innerHTML = `
                <td>${r.officeName || '-'}</td>
                <td>${maskedCode}</td>
                <td>${r.region || '-'}</td>
                <td>${r.quarter || '-'}</td>
                <td>${status}</td>
                <td>
                    ${actionButtons}
                    <button class="btn btn-sm btn-outline-primary ms-1" onclick="view(${r.id})">{{ "View"|t:current_lang }}</button>
                    <button class="btn btn-sm btn-outline-success ms-1" onclick="event.stopPropagation(); typingUsageReport(${r.id})">{{ "Typing Usage Report"|t:current_lang }}</button>
                </td>
            `;

                tr.addEventListener('click', () => {
                    if (r.status === 'Submitted') view(r.id);
                });

                tbody.appendChild(tr);
            });

        } catch (err) {
            console.error(err);
        }
    }

    function view(id) {
        fetch(`/qpr/api/records/${id}/`)
            .then(res => res.json())
            .then(record => {
                if (record.can_edit) {
                    localStorage.setItem('editRecordId', String(id));
                    window.location.href = "{% url 'qpr_form' %}";
                } else {
                    window.location.href = `/qpr/reports/${id}/`;
                }
            })
            .catch(err => {
                console.error(err);
                window.location.href = `/qpr/reports/${id}/`;
            });
    }

    function edit(id) {
        localStorage.setItem('editRecordId', String(id));
        window.location.href = "{% url 'qpr_form' %}";
    }

    function requestEdit(id) {
        const reason = prompt("{{ 'Please enter the reason for requesting to edit this report:'|t:current_lang }}");
        if (reason === null) return;

        if (!reason.trim()) {
            alert("{{ 'Please provide a reason for your request'|t:current_lang }}");
            return;
        }

        fetch(`/qpr/api/request-edit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                request_type: 'qpr',
                record_id: id,
                reason: reason
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("{{ 'Request sent successfully!'|t:current_lang }}");
                    loadList();
                } else {
                    alert("Error: " + (data.error || "Failed"));
                }
            })
            .catch(err => {
                console.error(err);
                alert("{{ 'Failed to send request'|t:current_lang }}");
            });
    }

    function typingUsageReport(id) {
        window.location.href = `/qpr/reports/${id}/typing-usage-report/`;
    }

    window.addEventListener('DOMContentLoaded', loadList);

</script>
{% endblock %}